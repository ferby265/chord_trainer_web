<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chord Trainer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="app-wrapper">
        <div class="app-container">

            <div id="chordDisplay">Press "Generate Chord" to start!</div>

            <div class="input-submit-group">
                <form id="answerForm" class="input-form">
                    <input type="text" id="userInput" placeholder="Enter notes (space-separated)" autocomplete="off" />
                    <button type="submit" class="submit-btn">Submit</button>
                </form>
            </div>


            <button onclick="generateChord()" id="generateButton">Generate Chord</button>

            <select id="difficulty">
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
                <option value="competition">Competition</option>
            </select>

            <!-- This Help button is now positioned bottom right -->
            <button type="button" class="help-button-fixed" onclick="toggleHelp()">Help</button>

            <!-- Help Popup remains unchanged -->
            <div id="helpPopup" class="help-popup hidden">
                <p><strong>Easy:</strong> Triads, sus chords, basic 7ths.</p>
                <p><strong>Medium:</strong> Adds 6ths, 9ths, 11ths, 13ths.</p>
                <p><strong>Hard:</strong> Adds altered chords (#5, b9, minMaj7, etc.).</p>
                <p><strong>Competition:</strong> Hard chords + 15s timer.</p>
            </div>

            <div id="helpPopup" class="help-popup hidden">
                <p><strong>Easy:</strong> Triads, sus chords, basic 7ths.</p>
                <p><strong>Medium:</strong> Adds 6ths, 9ths, 11ths, 13ths.</p>
                <p><strong>Hard:</strong> Adds altered chords (#5, b9, minMaj7, etc.).</p>
                <p><strong>Competition:</strong> Hard chords + 15s timer.</p>
            </div>

            <p id="feedback"></p>

            <div class="bottom-container">
                <div class="time-container">
                    <p id="timerDisplay">Timer: --s</p>
                    <p id="averageTimeDisplay">Average Time: --s</p>
                </div>
                <p id="scoreDisplay">Score: 0 / 0</p>
            </div>
        </div>
    </div>

    <script>
        let timer;
        let timeLeft = 15;
        let correctNotes = [];
        let correctCount = 0;
        let totalCount = 0;
        let intervals = [];
        let totalTimeSpent = 0;
        let answerCount = 0;
        let startTime;
        let currentDifficulty = 'easy';

        function noteToPitchClass(note) {
            const pitchClasses = {
                'C': 0, 'B#': 0, 'Dbb': 0,
                'C#': 1, 'Db': 1,
                'D': 2, 'C##': 2, 'Ebb': 2,
                'D#': 3, 'Eb': 3, 'Fbb': 3,
                'E': 4, 'Fb': 4, 'D##': 4,
                'F': 5, 'E#': 5, 'Gbb': 5,
                'F#': 6, 'Gb': 6, 'E##': 6,
                'G': 7, 'F##': 7, 'Abb': 7,
                'G#': 8, 'Ab': 8,
                'A': 9, 'G##': 9, 'Bbb': 9,
                'A#': 10, 'Bb': 10, 'Cbb': 10,
                'B': 11, 'Cb': 11, 'A##': 11
            };
            return pitchClasses[note];
        }

        function arraysEqual(a, b) {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        }

        const intervalLabels = {
            0: '1',
            1: 'b2',
            2: '2',
            3: 'b3',
            4: '3',
            5: '4',
            6: 'b5',
            7: '5',
            8: '#5',
            9: '6',
            10: 'b7',
            11: '7',
            12: '1',
            13: 'b9',
            14: '9',
            15: '#9',
            16: '3',
            17: '11(4)',
            18: '#11(b5)',
            19: '5',
            20: '#5/b13',
            21: '13(6)',
        };

        function getIntervalLabels(intervals) {
            return intervals.map(semitones => intervalLabels[semitones] || semitones).join(' ');
        }

        function generateChord() {
            const difficulty = document.getElementById('difficulty').value;

            if (difficulty !== currentDifficulty) {
                totalTimeSpent = 0;
                answerCount = 0;
                updateAverageTime();
                currentDifficulty = difficulty;
            }

            fetch(`/generate_chord?difficulty=${difficulty}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('chordDisplay').innerText = `Spell the notes in: ${data.root}${data.chord_type}`;
                    correctNotes = data.correct_notes;
                    chord_type = data.chord_type;
                    intervals = data.intervals; // ✅ Store intervals from backend

                    startTimer(difficulty);
                    document.getElementById('feedback').innerText = "";
                    document.getElementById('userInput').value = "";

                    startTime = Date.now();
                })
                .catch(error => {
                    console.error("Error fetching chord:", error);
                    document.getElementById('feedback').innerText = "❌ Failed to get a new chord. Check console.";
                });
        }



        function getIntervalLabels(intervals) {
            return intervals.map(semitones => intervalLabels[semitones] || semitones).join(' ');
        }

        function startTimer(difficulty) {
            clearInterval(timer);
            timeLeft = difficulty === 'competition' ? 15 : 30;
            const timerDisplay = document.getElementById('timerDisplay');

            timer = setInterval(() => {
                timerDisplay.innerText = `Timer: ${timeLeft}s`;
                timeLeft--;

                if (timeLeft < 0) {
                    clearInterval(timer);
                    timerDisplay.innerText = "Time's up!";
                }
            }, 1000);
        }

        function checkAnswer() {
            const userAnswer = document.getElementById('userInput').value.trim().split(/\s+/);
            const userPitchClasses = userAnswer.map(noteToPitchClass);
            const correctPitchClasses = correctNotes.map(noteToPitchClass);

            clearInterval(timer);

            const endTime = Date.now();
            const timeTaken = (endTime - startTime) / 1000;

            totalTimeSpent += timeTaken;
            answerCount++;
            updateAverageTime();
            totalCount++;

            if (arraysEqual(userPitchClasses, correctPitchClasses)) {
                correctCount++;
                document.getElementById('feedback').innerText = "✅ Correct!";
                updateScore();
                setTimeout(generateChord, 1000);
            } else {
                const intervalText = intervals.map(semitones => intervalLabels[semitones] || semitones);
                const semitoneText = intervals.map(String);

                const numNotes = correctNotes.length;
                const noteRow = correctNotes.map(note => `<div class="chord-cell">${note}</div>`).join('');
                const intervalRow = intervalText.map(interval => `<div class="chord-cell">${interval}</div>`).join('');
                const semitoneRow = semitoneText.map(semitone => `<div class="chord-cell">${semitone}</div>`).join('');

                document.getElementById('feedback').innerHTML = `
            ❌ Incorrect!<br>
            <div class="chord-grid">
                <div class="chord-label">Correct Notes:</div>
                <div class="chord-row" style="grid-template-columns: repeat(${numNotes}, 1fr);">${noteRow}</div>

                <div class="chord-label">Intervals:</div>
                <div class="chord-row" style="grid-template-columns: repeat(${numNotes}, 1fr);">${intervalRow}</div>

                <div class="chord-label">Semitones:</div>
                <div class="chord-row" style="grid-template-columns: repeat(${numNotes}, 1fr);">${semitoneRow}</div>
            </div>
        `;
                updateScore();
            }
        }



        function updateScore() {
            document.getElementById('scoreDisplay').innerText = `Score: ${correctCount} / ${totalCount}`;
        }

        function updateAverageTime() {
            const averageTime = answerCount === 0 ? '--' : (totalTimeSpent / answerCount).toFixed(2);
            document.getElementById('averageTimeDisplay').innerText = `Average Time: ${averageTime}s`;
        }

        function toggleHelp() {
            const popup = document.getElementById('helpPopup');
            popup.classList.toggle('hidden');
        }

        document.getElementById('answerForm').addEventListener('submit', function (e) {
            e.preventDefault(); // Stop form from reloading page
            checkAnswer();
        });

    </script>