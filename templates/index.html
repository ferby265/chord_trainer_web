<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chord Trainer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="app-wrapper">
        <div class="app-container">

            <div id="chordDisplay">Press "Generate Chord" to start!</div>

            <div class="input-submit-group">
                <form id="answerForm" onsubmit="checkAnswer(); return false;" class="input-form">
                    <input type="text" id="userInput" placeholder="Enter notes (space-separated)" autocomplete="off" />
                    <button type="submit" class="submit-btn">Submit</button>
                </form>
            </div>

            <button onclick="generateChord()" id="generateButton">Generate Chord</button>

            <select id="difficulty">
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
                <option value="competition">Competition</option>
            </select>

            <!-- This Help button is now positioned bottom right -->
            <button type="button" class="help-button-fixed" onclick="toggleHelp()">Help</button>

            <!-- Help Popup remains unchanged -->
            <div id="helpPopup" class="help-popup hidden">
                <p><strong>Easy:</strong> Triads, sus chords, basic 7ths.</p>
                <p><strong>Medium:</strong> Adds 6ths, 9ths, 11ths, 13ths.</p>
                <p><strong>Hard:</strong> Adds altered chords (#5, b9, minMaj7, etc.).</p>
                <p><strong>Competition:</strong> Hard chords + 15s timer.</p>
            </div>

            <div id="helpPopup" class="help-popup hidden">
                <p><strong>Easy:</strong> Triads, sus chords, basic 7ths.</p>
                <p><strong>Medium:</strong> Adds 6ths, 9ths, 11ths, 13ths.</p>
                <p><strong>Hard:</strong> Adds altered chords (#5, b9, minMaj7, etc.).</p>
                <p><strong>Competition:</strong> Hard chords + 15s timer.</p>
            </div>

            <p id="feedback"></p>

            <div class="bottom-container">
                <div class="time-container">
                    <p id="timerDisplay">Timer: --s</p>
                    <p id="averageTimeDisplay">Average Time: --s</p>
                </div>
                <p id="scoreDisplay">Score: 0 / 0</p>
            </div>
        </div>
    </div>

    <script>
        let timer;
        let timeLeft = 15;
        let correctNotes = [];
        let correctCount = 0;
        let totalCount = 0;

        let totalTimeSpent = 0;
        let answerCount = 0;
        let startTime;
        let currentDifficulty = 'easy';

        function noteToPitchClass(note) {
            const pitchClasses = {
                'C': 0, 'B#': 0, 'Dbb': 0,
                'C#': 1, 'Db': 1,
                'D': 2, 'C##': 2, 'Ebb': 2,
                'D#': 3, 'Eb': 3, 'Fbb': 3,
                'E': 4, 'Fb': 4, 'D##': 4,
                'F': 5, 'E#': 5, 'Gbb': 5,
                'F#': 6, 'Gb': 6, 'E##': 6,
                'G': 7, 'F##': 7, 'Abb': 7,
                'G#': 8, 'Ab': 8,
                'A': 9, 'G##': 9, 'Bbb': 9,
                'A#': 10, 'Bb': 10, 'Cbb': 10,
                'B': 11, 'Cb': 11, 'A##': 11
            };
            return pitchClasses[note];
        }

        function arraysEqual(a, b) {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        }

        function generateChord() {
            const difficulty = document.getElementById('difficulty').value;

            if (difficulty !== currentDifficulty) {
                totalTimeSpent = 0;
                answerCount = 0;
                updateAverageTime();
                currentDifficulty = difficulty;
            }

            fetch(`/generate_chord?difficulty=${difficulty}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('chordDisplay').innerText = `Spell the notes in: ${data.root}${data.chord_type}`;
                    correctNotes = data.correct_notes;
                    startTimer(difficulty);
                    document.getElementById('feedback').innerText = "";
                    document.getElementById('userInput').value = "";

                    startTime = Date.now(); // Start timing
                });
        }

        function startTimer(difficulty) {
            clearInterval(timer);
            timeLeft = difficulty === 'competition' ? 15 : 30;
            const timerDisplay = document.getElementById('timerDisplay');

            timer = setInterval(() => {
                timerDisplay.innerText = `Timer: ${timeLeft}s`;
                timeLeft--;

                if (timeLeft < 0) {
                    clearInterval(timer);
                    timerDisplay.innerText = "Time's up!";
                }
            }, 1000);
        }

        function checkAnswer() {
            const userAnswer = document.getElementById('userInput').value.trim().split(/\s+/);
            const userPitchClasses = userAnswer.map(noteToPitchClass);
            const correctPitchClasses = correctNotes.map(noteToPitchClass);

            clearInterval(timer); // Stop the timer when answering

            const endTime = Date.now();
            const timeTaken = (endTime - startTime) / 1000; // in seconds

            totalTimeSpent += timeTaken;
            answerCount++;

            updateAverageTime();

            totalCount++;

            if (arraysEqual(userPitchClasses, correctPitchClasses)) {
                correctCount++;
                document.getElementById('feedback').innerText = "✅ Correct!";
                updateScore();

                setTimeout(generateChord, 1000);
            } else {
                document.getElementById('feedback').innerText = `❌ Incorrect! Correct notes: ${correctNotes.join(' ')}`;
                updateScore();
            }
        }

        function updateScore() {
            document.getElementById('scoreDisplay').innerText = `Score: ${correctCount} / ${totalCount}`;
        }

        function updateAverageTime() {
            const averageTime = answerCount === 0 ? '--' : (totalTimeSpent / answerCount).toFixed(2);
            document.getElementById('averageTimeDisplay').innerText = `Average Time: ${averageTime}s`;
        }

        function toggleHelp() {
            const popup = document.getElementById('helpPopup');
            popup.classList.toggle('hidden');
        }
    </script>