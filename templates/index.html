<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chord Trainer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Additional styles for menu and app screens */
    </style>
</head>

<body>
    <!-- Menu Screen (shown on load) -->
    <div id="menuScreen" class="menu-screen">
        <button onclick="selectMode('spell')">Spell Chord</button>
        <button onclick="selectMode('name')">Name Chord</button>
        <button onclick="selectMode('scale')">Scales</button>
        <button disabled>Root/Interval (Coming Soon)</button>
        <button disabled>Harmony (Coming Soon)</button>
    </div>

    <!-- App Screen (hidden on load) -->
    <div id="appScreen" class="hidden">
        <button onclick="goBackToMenu()" class="back-button">‚Üê Menu</button>
        <div class="app-wrapper">
            <div class="app-container">
                <div id="chordDisplay">Press "Generate Chord" to start!</div>
                <div class="input-submit-group">
                    <form id="answerForm" class="input-form">
                        <input type="text" id="userInput" placeholder="Enter notes (space-separated)"
                            autocomplete="off" />
                        <button type="submit" class="submit-btn">Submit</button>
                    </form>
                </div>
                <button onclick="generateQuestion()" id="generateButton">Generate</button>
                <select id="difficulty">
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                    <option value="competition">Competition</option>
                </select>
                <button type="button" class="help-button-fixed" onclick="toggleHelp()">Help</button>
                <div id="helpPopup" class="help-popup hidden">
                    <p><strong>Easy:</strong> Basic triads, sus chords, basic 7ths, 6th chords, add chords.</p>
                    <p><strong>Medium:</strong> Adds 9ths, 11ths, 13ths, suspended dominants.</p>
                    <p><strong>Hard:</strong> Adds altered dominants, diminished, minMaj7, accidentals.</p>
                    <p><strong>Competition:</strong> Same as Hard but with a 15s timer.</p>
                    <p><strong>Shell Mode:</strong> Reduces chords to Root, 3rd, 7th, and essential extensions.</p>
                </div>
                <p id="feedback" class="feedback-container"></p>
                <div class="bottom-container">
                    <div class="time-container">
                        <p id="timerDisplay">Timer: --s</p>
                        <p id="averageTimeDisplay">Average Time: --s</p>
                    </div>
                    <div class="score-shell-wrapper">
                        <p id="scoreDisplay">Score: 0 / 0</p>
                        <div class="shell-toggle-wrapper" onclick="toggleShellMode()">
                            <span id="shellCheckbox" class="shell-checkbox">‚òê</span>
                            <span id="shellToggle" class="shell-icon">üêö Shell Mode</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        console.log("SCRIPT LOADED!");
        let timer;
        let timeLeft = 15;
        let correctNotes = [];
        let correctCount = 0;
        let shellModeActive = false;
        let totalCount = 0;
        let intervals = [];
        let totalTimeSpent = 0;
        let answerCount = 0;
        let currentMode = 'spell'; // Default mode
        let startTime;
        let currentDifficulty = 'easy';
        let root;
        let chordType;

        // Helper: Note to pitch class conversion
        function noteToPitchClass(note) {
            const pitchClasses = {
                'C': 0, 'B#': 0, 'Dbb': 0, 'C#': 1, 'Db': 1, 'D': 2, 'C##': 2, 'Ebb': 2,
                'D#': 3, 'Eb': 3, 'E': 4, 'Fb': 4, 'F': 5, 'E#': 5, 'F#': 6, 'Gb': 6,
                'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11, 'Cb': 11
            };
            return pitchClasses[note];
        }

        function arraysEqual(a, b) {
            return a.length === b.length && a.every((v, i) => v === b[i]);
        }

        // Menu switching functions
        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('menuScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
        }

        function goBackToMenu() {
            document.getElementById('menuScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
        }

        function toggleShellMode() {
            shellModeActive = !shellModeActive;
            document.getElementById('shellCheckbox').innerText = shellModeActive ? '‚òëÔ∏è' : '‚òê';
            document.getElementById('shellToggle').style.color = shellModeActive ? 'black' : '#aaa';
        }

        // Interval labels
        const intervalLabels = {
            0: '1', 1: 'b2', 2: '2', 3: 'b3', 4: '3', 5: '4', 6: 'b5', 7: '5', 8: '#5',
            9: '6', 10: 'b7', 11: '7', 13: 'b9', 14: '9', 15: '#9', 17: '11', 18: '#11',
            20: 'b13', 21: '13', 22: '#13',
        };

        // Generate chord function (fetches chord from server)
        function generateChord() {
            const difficulty = document.getElementById('difficulty').value;
            if (difficulty !== currentDifficulty) {
                totalTimeSpent = 0;
                answerCount = 0;
                updateAverageTime();
                currentDifficulty = difficulty;
            }
            fetch(`/generate_chord?difficulty=${difficulty}&shell_mode=${shellModeActive}`)
                .then(response => response.json())
                .then(data => {
                    root = data.root;
                    chordType = data.chord_type;
                    correctNotes = data.correct_notes;
                    intervals = data.intervals;
                    if (currentMode === 'spell') {
                        document.getElementById('chordDisplay').innerText = `Spell the notes in: ${root}${chordType}`;
                    } else if (currentMode === 'name') {
                        document.getElementById('chordDisplay').innerText = `Name this chord: ${correctNotes.join(' ')}`;
                    }
                    document.getElementById('feedback').innerText = "";
                    document.getElementById('userInput').value = "";
                    startTimer(difficulty);
                    startTime = Date.now();
                })
                .catch(error => {
                    console.error("Error fetching chord:", error);
                    document.getElementById('feedback').innerText = "‚ùå Failed to get a new chord. Check console.";
                });
        }

        function startTimer(difficulty) {
            clearInterval(timer);
            timeLeft = difficulty === 'competition' ? 15 : 30;
            timer = setInterval(() => {
                document.getElementById('timerDisplay').innerText = `Timer: ${timeLeft}s`;
                timeLeft--;
                if (timeLeft < 0) clearInterval(timer);
            }, 1000);
        }

        function checkAnswer() {
            // --- SCALE MODE FIRST ---
            if (currentMode === 'scale') {
                if (!correctNotes.length) {
                    document.getElementById('feedback').innerText = "‚ùå Generate a scale first!";
                    return;
                }

                const userAnswer = document.getElementById('userInput').value.trim();
                clearInterval(timer);
                const endTime = Date.now();
                const timeTaken = (endTime - startTime) / 1000;
                totalTimeSpent += timeTaken;
                answerCount++;
                totalCount++;

                const userPitchClasses = userAnswer.split(/\s+/).map(noteToPitchClass);
                const correctPitchClasses = correctNotes.map(noteToPitchClass);

                if (arraysEqual(userPitchClasses, correctPitchClasses)) {
                    correctCount++;
                    displayFeedback(true);
                    setTimeout(generateQuestion, 1000);
                } else {
                    displayFeedback(false);
                }

                updateScore();
                updateAverageTime();
                return; // stop here so chord logic doesn‚Äôt also run
            }

            // --- CHORD MODES (SPELL / NAME) ---
            if (!correctNotes.length) {
                document.getElementById('feedback').innerText = "‚ùå Generate a chord first!";
                return;
            }

            const userAnswer = document.getElementById('userInput').value.trim();
            clearInterval(timer);
            const endTime = Date.now();
            const timeTaken = (endTime - startTime) / 1000;
            totalTimeSpent += timeTaken;
            answerCount++;
            totalCount++;

            if (currentMode === 'spell') {
                const userPitchClasses = userAnswer.split(/\s+/).map(noteToPitchClass);
                const correctPitchClasses = correctNotes.map(noteToPitchClass);
                if (arraysEqual(userPitchClasses, correctPitchClasses)) {
                    correctCount++;
                    displayFeedback(true);
                    setTimeout(generateChord, 1000);
                } else {
                    displayFeedback(false);
                }
            } else if (currentMode === 'name') {
                if (userAnswer === `${root}${chordType}`) {
                    correctCount++;
                    displayFeedback(true);
                    setTimeout(generateChord, 1000);
                } else {
                    displayFeedback(false, true);
                }
            }

            updateScore();
            updateAverageTime();
        }

        function displayFeedback(isCorrect, isNameMode = false) {
            const numNotes = correctNotes.length;
            const noteRow = correctNotes.map(n => `<div class="chord-cell">${n}</div>`).join('');

            // --- build intervalRow (your new logic already here) ---
            let intervalRow;
            if (currentMode === 'scale') {
                const has = new Set(intervals);
                const pickLabel = (pc) => {
                    switch (pc) {
                        case 0: return '1'; case 1: return 'b2'; case 2: return '2';
                        case 3: return 'b3'; case 4: return '3'; case 5: return '4';
                        case 6: return has.has(7) ? '#4' : 'b5';
                        case 7: return '5';
                        case 8: return has.has(9) ? '#5' : 'b6';
                        case 9: return '6'; case 10: return 'b7'; case 11: return '7';
                        default: return pc;
                    }
                };
                intervalRow = intervals.map(v => `<div class="chord-cell">${pickLabel(v)}</div>`).join('');
            } else {
                const chordLabels = {
                    0: '1', 1: 'b2', 2: '2', 3: 'b3', 4: '3', 5: '4',
                    6: '#4/b5', 7: '5', 8: '#5/b6', 9: '6', 10: 'b7', 11: '7',
                    13: 'b9', 14: '9', 15: '#9', 17: '11', 18: '#11', 20: 'b13', 21: '13'
                };
                intervalRow = intervals
                    .map(v => `<div class="chord-cell">${chordLabels[v] ?? v}</div>`)
                    .join('');
            }

            // --- build stepsRow (this was missing) ---
            const stepsRow = intervals
                .map((v, i) => (i === 0 ? '' : `+${v - intervals[i - 1]}`))
                .map(txt => `<div class="chord-cell">${txt}</div>`)
                .join('');

            const semitoneRow = intervals.map(v => `<div class="chord-cell">${v}</div>`).join('');

            if (isCorrect) {
                document.getElementById('feedback').innerText = "‚úÖ Correct!";
            } else {
                document.getElementById('feedback').innerHTML = `
      ‚ùå Incorrect!<br>
      ${isNameMode ? `<strong>Correct Chord:</strong> ${root}${chordType}<br><br>` : ''}
      <div class="chord-grid">
        <div class="chord-label">Correct Notes:</div>
        <div class="chord-row" style="grid-template-columns: repeat(${numNotes}, 1fr);">${noteRow}</div>
        <div class="chord-label">Intervals:</div>
        <div class="chord-row" style="grid-template-columns: repeat(${numNotes}, 1fr);">${intervalRow}</div>
        <div class="chord-label">Formula:</div>
        <div class="chord-row" style="grid-template-columns: repeat(${numNotes}, 1fr);">${stepsRow}</div>
        <div class="chord-label">Semitones (Root):</div>
        <div class="chord-row" style="grid-template-columns: repeat(${numNotes}, 1fr);">${semitoneRow}</div>
      </div>
    `;
            }
        }


        function updateAverageTime() {
            const average = answerCount === 0 ? '--' : (totalTimeSpent / answerCount).toFixed(2);
            document.getElementById('averageTimeDisplay').innerText = `Average Time: ${average}s`;
        }

        function updateScore() {
            document.getElementById('scoreDisplay').innerText = `Score: ${correctCount} / ${totalCount}`;
        }

        function toggleHelp() {
            document.getElementById('helpPopup').classList.toggle('hidden');
        }

        // Initialize once the DOM is fully loaded
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById('menuScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
        });

        document.getElementById('answerForm').addEventListener('submit', function (e) {
            e.preventDefault();
            checkAnswer();
        });

        function generateQuestion() {
            const difficulty = document.getElementById('difficulty').value;

            if (currentMode === 'scale') {
                fetch(`/generate_scale?difficulty=${difficulty}`)
                    .then(response => response.json())
                    .then(data => {
                        root = data.root;
                        const scaleType = data.scale_type; // e.g. "dorian", "whole_tone"
                        correctNotes = data.correct_notes;
                        intervals = data.intervals;

                        const pretty = scaleType.replaceAll('_', ' ');
                        document.getElementById('chordDisplay').innerText =
                            `Spell the notes in: ${root} ${pretty} scale`;

                        // Shell mode makes no sense for scales ‚Äî dim it & reset if on
                        if (shellModeActive) toggleShellMode();
                        document.querySelector('.shell-toggle-wrapper').style.opacity = 0.35;

                        document.getElementById('feedback').innerText = "";
                        document.getElementById('userInput').value = "";
                        startTimer(difficulty);
                        startTime = Date.now();
                    })
                    .catch(err => {
                        console.error(err);
                        document.getElementById('feedback').innerText = "‚ùå Failed to get a scale. Check console.";
                    });
                return;
            }

            // chord modes (‚Äúspell‚Äù / ‚Äúname‚Äù)
            document.querySelector('.shell-toggle-wrapper').style.opacity = 1;
            generateChord(); // continues to respect difficulty & shell mode
        }
    </script>
</body>

</html>